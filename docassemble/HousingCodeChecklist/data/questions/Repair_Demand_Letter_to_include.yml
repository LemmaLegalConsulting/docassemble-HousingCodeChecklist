---
include:
  - docassemble.AssemblyLine:al_package.yml
  - docassemble.ALMassachusetts:al_massachusetts.yml
---
mandatory: True
comment: |
  This contains metadata that will not be overwritten if this YAML file is included in another
  file. Each file gets its own key in the interview_metadata dictionary.
  Most keys are not currently used at runtime, other than "allowed courts".
code: |
  interview_metadata
  if not defined("interview_metadata['Repair_Demand_Letter']"):
    interview_metadata.initializeObject("Repair_Demand_Letter")
    interview_metadata["Repair_Demand_Letter"].update({
      "al_weaver_version": "1.6.2",
      "generated on": "2022-03-31",
      "title": "Repair Demand Letter",
      "short title": "Repair Demand Letter",
      "description": "A letter of demand for relief under the Consumer Protection Act, Chapter 93A",
      "original_form": "https://www.masslegalhelp.org/housing/lt1-form-10-repair-demand.pdf",
      "allowed courts": [
      ],
      "categories": [
      ],        
      "logic block variable": "interview_order_Repair_Demand_Letter",
      "attachment block variable": "Repair_Demand_Letter_attachment",
      "typical role": "na",
    })
---
objects:
  - other_parties: ALPeopleList.using(ask_number=True,target_number=1)
  - users: ALPeopleList.using(ask_number=True,target_number=1)
---
#################### Interview order #####################
comment: |
  Controls order and branching logic for questions specific to this form
id: interview_order_Repair_Demand_Letter
code: |
  # Set the allowed courts for this interview
  allowed_courts = interview_metadata["Repair_Demand_Letter"]["allowed courts"]
  nav.set_section('review_Repair_Demand_Letter')
  user_role = 'na'
  users.gather()
  set_parts(subtitle=str(users))
  users[0].address.address
  other_parties.gather()
  set_progress(20)
  other_parties[0].address.address
  time_frame
  notification_date
  set_progress(40)
  if written_notification == True:
     letter_date
  tenant_repair_issue_description
  effect_of_conditions
  set_progress(60)
  tenant_rent_amount
  amount
  interview_order_Repair_Demand_Letter = True
---
comment: |
  This question is used to introduce your interview. Please customize
id: Repair_Demand_Letter
continue button field: Repair_Demand_Letter_intro
question: |
  Repair Demand Letter
subquestion: |
  This interview will help you write a letter to your landlord asking them to pay you 
  because they did not fix a problem in your home, such as:
  
  - lack of heat,
  - mice or insects, 
  - or any other bad housing condition that is your landlord's responsibility.
  
  Your landlord has 30 days to answer your letter with an amount that is fair.

  ${ collapse_template(help_93a_damages_explanation) }

  At the end of this interview you will get a letter that you need to deliver to your
  landlord.
---
template: help_93a_damages_explanation
subject: |
  What happens if my landlord ignores me?
content: |
  If your landlord: 
  
  - does not answer the letter, or
  - answers but does not offer to pay you a fair amount
  
  Then a court may decide that you have a right to be paid triple damages.
  Triple damages means that a judge or jury calculates the amount that the law says 
  would repay you for the harm caused by your landlord. 
  Then they multiply it by 3. For example:
  
  If | then the amount you would get is
  ---|-----------------------------------
  The jury decides that $500 would repay you | $1,500 instead

---
sets:
  - other_parties[i].name.first
  - other_parties[i].name.last
  - other_parties[i].name.middle
  - other_parties[i].name.suffix
id: names of opposing parties
question: |
  What is your landlord's name?
fields:
  - code: |
      other_parties[i].name_fields(person_or_business='unsure')
---
sets: 
  - other_parties[0].address.address
  - other_parties[0].address.city
id: What is the landlord s address
question: |
  What is your landlord's address?
fields:
  - code: |
      other_parties[0].address_fields(default_state="MA")
---
id: How long have you lived at the address
question: |
  When did you move in to ${ users[0].address.on_one_line() }?
subquestion: |
  State the best date that you know. You can say an exact date or an estimate, like
  "June of 2020".
fields:
  - Date you moved in: time_frame
---
id: When did you first notify the landlord of the bad conditions
question: |
  What is the first time that you told the landlord about the problem?
subquestion: |
  State the best date that you know. You can say an exact date or an estimate, like
  "June of 2020".
fields:
  - Date notified landlord: notification_date
  - Did you notify your landlord about the problem in writing?: written_notification
    datatype: yesnoradio
  - When?: letter_date
    show if: written_notification
---
id: Describe the repairs
question: |
  What needs to be repaired right now?
fields:
  -  Tell the landlord what needs to be fixed: tenant_repair_issue_description
     label above field: True
     input type: area
     rows: 4
---
id: How have the conditions affected you and your property
question: |
  How have the conditions affected you and your property?
subquestion: |
  ${ collapse_template(help_effect_of_conditions) }
fields:
  - Explain the effect on you: effect_of_conditions
    label above field: True
    input type: area
    rows: 3
---
template: help_effect_of_conditions
subject: |
  What can I say?
content: |
    Tell your landlord how the problems have hurt you. Use your own words.
    Include facts about:
    
    1. whether you were physically injured or uncomfortable
    1. any money you had to spend because of the problem
    1. how having the problems makes you feel (such as disgust, fear, lack of safety)
    
    Example: Last week my 4 year old son tripped over the hole in the floor.
    He scraped his knee and cried for 20 minutes. We don't feel safe in our home.
---
id: rent amount
question: |
  How much is your rent?
fields:
  - How much is the monthly rent for your apartment?: tenant_rent_amount
    datatype: currency
  - Do you get a rent subsidy?: tenant_gets_rent_subsidy
    datatype: yesnoradio
  - How much is the **market** rent for your apartment?: tenant_market_rent
    datatype: currency
    show if: tenant_gets_rent_subsidy
    help: |
      Write down the best number you know. If you have a voucher, for example,
      write down the total market rent: the amount you pay plus the amount your
      housing authority pays.
---
id: How much compensation would you like to claim from the landlord?
question: |
  What amount of money would be fair for your landlord to pay you?
subquestion: |
  ${ collapse_template(settlement_offer_93a_explanation) }
  
  The amount that you list here will be your "settlement offer".  
  
fields:
  - How do you want to decide the amount to ask for?: damage_calculation_method
    datatype: radio
    choices:
      - Let me do my own math: tenant_calculation
      - Help me with the math: uptocode_calculation
  - How serious was the problem?: damage_tenant_severity_estimate
    datatype: radio
    choices:
      - The apartment was unlivable: bqe_total
        help: |
          You can choose this answer even if you did not move out.
      - The problem was serious but not unlivable: bqe_partial
    show if:      
      variable: damage_calculation_method
      is: uptocode_calculation
  - How long did you have the problem? (Write a number and say if it happened over days, weeks, months or years): tenant_time_estimate
    datatype: number
    show if:      
      variable: damage_calculation_method
      is: uptocode_calculation
  - Time period: tenant_time_estimate_denominator
    choices:
      - Days: 365
      - Weeks: 52
      - Months: 12
      - Years: 1
    help: |
      Choose the **time period** that goes with the **number** you wrote above so that it makes
      a complete sentence.
    datatype: integer
    show if:      
      variable: damage_calculation_method
      is: uptocode_calculation
  - What **percentage** do you think is fair to get off of the rent for each month that you had the problem?: tenant_percentage_estimate
    datatype: range
    min: 0
    max: 100
    step: 5
    default: 0
    show if:
      variable: damage_calculation_method
      is: uptocode_calculation
    help: |
      It is up to you to ask for a perecentage you think is fair. A less serious problem might 
      be 5% and a very serious problem might be 100%. The total amount cannot be more than 100%.
      The percentage will be multiplied by the number of days, weeks or months you had the problem.
    validate: |
      lambda y: y > 0 or validation_error("Select a number greater than 0.")
  - Settlement offer amount: tenant_self_estimated_damages_amount
    datatype: currency
    min: 0
    show if:
      variable: damage_calculation_method
      is: tenant_calculation
validation code: |
  if damage_calculation_method == "uptocode_calculation":
    if tenant_percentage_estimate < 5:
      validation_error("Select a percentage that is greater than 0", field="tenant_percentage_estimate")
---
depends on:
  - damage_calculation_method
  - tenant_confirmed_uptocode_damages_estimate
  - tenant_self_estimated_damages_amount
code: |
  if damage_calculation_method == "uptocode_calculation":
    amount = tenant_confirmed_uptocode_damages_estimate
  else:
    amount = tenant_self_estimated_damages_amount
---
id: preview damages calculation
question: |
  Your settlement offer estimate
subquestion: |
  You told us the following information:
  
  * The market rent for your home is ${ bold(currency(tenant_rent_amount if not tenant_gets_rent_subsidy else tenant_market_rent)) }
  % if damage_tenant_severity_estimate == "bqe_total":
  * Your home was not livable
  % else:
  * Your home was livable despite the serious problems
  % endif
  * You had the problem for about ${ tenant_time_estimate } 
  % if tenant_time_estimate_denominator == 365:
  days
  % elif tenant_time_estimate_denominator == 52:
  weeks
  % elif tenant_time_estimate_denominator == 12:
  months
  % else:
  years
  % endif  
  % if tenant_time_estimate / tenant_time_estimate_denominator >= 6:
  
  **Note**: you can usually only ask your landlord to pay you back for a problem that happened in the 
  last **6** years. Our estimate will assume you had the problem for exactly 6 years.
  % endif
  
  Based on the information that you told us, 
  % if damage_tenant_severity_estimate == "bqe_total":
  you could get up to 3 times the monthly rent, or ${ bold(currency(three_times_rent_amount)) }.
  
  Or, 
  % endif  
  you could get ${ bold(currency(tenant_warranty_estimate)) } based on getting a 
  ${ tenant_percentage_estimate }% reduction in your rent.  
fields:
  - Confirm your settlement offer amount: tenant_confirmed_uptocode_damages_estimate
    datatype: currency
    default: |
      ${ max(three_times_rent_amount, tenant_warranty_estimate) if damage_tenant_severity_estimate == "bqe_total" else tenant_warranty_estimate }
    help: |
      % if tenant_time_estimate / tenant_time_estimate_denominator >= 6:
      **We limited the time period for your rent reduction because it was more than 6 years.**
      % endif
      This estimate depends on the information that you gave us. Remember, you should only ask for 
      the amount that you could get by going to court.      
---
depends on:
  - tenant_rent_amount
  - tenant_gets_rent_subsidy
  - tenant_market_rent
code: |
  three_times_rent_amount = 3 * (
      tenant_rent_amount if not tenant_gets_rent_subsidy else tenant_market_rent
  )
---
depends on:
  - tenant_rent_amount
  - tenant_gets_rent_subsidy
  - tenant_market_rent
  - tenant_time_estimate
  - tenant_time_estimate_denominator
  - tenant_percentage_estimate  
code: |
  tenant_warranty_estimate = (
    (tenant_rent_amount if not tenant_gets_rent_subsidy else tenant_market_rent) * 12 * (
      min(tenant_time_estimate / tenant_time_estimate_denominator, 6)
    ) * tenant_percentage_estimate / 100
  )
---
template: settlement_offer_93a_explanation
subject: |
  What amount can I ask for?
content: |
  You can ask for an amount that you can get if you won a case against your landlord in court.
  Usually, the largest amount you can get in court is 3 times your rent, but tenants who had very serious
  problems or who had problems over a long period of time may get more.
  
  The most common reasons that your landlord may owe you money are:
  
  If | Then the amount your landlord might owe you is
  ---|-----------------------------------------------
  You had a serious problem that made the apartment practically unlivable | **3 times the market rent** for your apartment, assuming it was in good repair
  You had **any** problem that your landlord was required to fix | **A fair percentage off of your rent** for each month that you had the problem
  You had to pay an actual amount out of pocket because of the problem, such as replacing food or personal belongings that were damaged | The **actual amount** you had to pay out of pocket
  
  If multiple rules apply, your landlord only owes you the **highest** number to compensate you. You can
  only collect once for the same problem.
  
  Examples of very serious problems that might mean you can get 3 times the market rent include:
  
  * Having no heat or hot water during a very cold part of the winter
  * Having a serious structural problem, like a ceiling collapse
  * Having a very bad environmental problem, like bed bugs, mold, or a smell that you cannot live
    with

  But it is up to a judge or jury to decide how serious the problem is.

  For most tenants, the second rule applies. You can ask for a fair amount off of your rent for each 
  month or part of a month that you had the problem.
  
  For example, if you had a problem for a whole month and your rent was $2,000/month, and:
  
  If | And a fair percentage to take off of the rent was | Then the amount you can ask for would be
  ---|---------------------------|-----------------------------------
  You had a minor problem with mice | 10% | $200
  You had no heat during a mild part of the winter | 50% | $1000
  You could not lock your doors | 25% | $500

  The amount that is a fair percentage to ask for depends on your individual circumstances. It is up
  to a judge or jury to decide what amount is fair.
---
code: |
  signature_fields = ['users[0].signature']
---
id: Repair Demand Letter review screen
event: review_Repair_Demand_Letter
question: |
  Review your answers
review:
  - Edit: other_parties.revisit
    button: |
      **Other parties**

      % for item in other_parties:
        * ${ item }
      % endfor
  - Edit: effect_of_conditions
    button: |
      **Effect of Conditions**:
      ${ effect_of_conditions }
  - Edit: notification_date
    button: |
      **Date of Notification**:
      ${ notification_date }
  - Edit: tenant_repair_issue_description
    button: |
      **Tenant repair issue description**:
      ${ tenant_repair_issue_description }
  - Edit: amount
    button: |
      **Amount**:
      ${ currency(amount) }
  - Edit: time_frame
    button: |
      **Time frame**:
      ${ time_frame }
  - Edit: letter_date
    button: |
      **Date of Letter**:
      ${ letter_date }
  - Edit: users.revisit
    button: |
      **Users**

      % for item in users:
        * ${ item }
      % endfor
---
continue button field: other_parties.revisit
question: |
  Edit other_parties
subquestion: |
  ${ other_parties.table }

  ${ other_parties.add_action() }
---
table: other_parties.table
rows: other_parties
columns:
  - Address: |
      row_item.address.block() if defined("row_item.address.address") else ""
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
edit:
  - address.address
  - name.first
confirm: True

---
continue button field: users.revisit
question: |
  Edit users
subquestion: |
  ${ users.table }

  ${ users.add_action() }
---
table: users.table
rows: users
columns:
  - Signature: |
      row_item.signature if defined("row_item.signature") else ""
  - Address: |
      row_item.address.block() if defined("row_item.address.address") else ""
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
edit:
  - signature
  - address.address
  - name.first
confirm: True
---
objects:
  - Repair_Demand_Letter_post_interview_instructions: ALDocument.using(title="Instructions", filename="Repair_Demand_Letter_next_steps.docx", has_addendum=False, default_overflow_message=AL_DEFAULT_OVERFLOW_MESSAGE)
  - Repair_Demand_Letter_attachment: ALDocument.using(title="Repair Demand Letter", filename="Repair_Demand_Letter.docx", has_addendum=False, default_overflow_message=AL_DEFAULT_OVERFLOW_MESSAGE)
---
attachments:
  - name: Repair Demand Letter post interview instructions
    filename: Post-interview-instructions     
    variable name: Repair_Demand_Letter_post_interview_instructions[i]        
    skip undefined: True
    docx template file: Repair_Demand_Letter_next_steps.docx
  - name: Repair Demand Letter attachment
    filename: Repair_Demand_Letter.docx     
    variable name: Repair_Demand_Letter_attachment[i]
    skip undefined: True
    docx template file: Repair_Demand_Letter.docx
